name: Release mlx-host (darwin-arm64)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build/release (e.g. v0.0.1)"
        required: true
        default: "v0.0.1"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # When manually dispatched, build the requested tag. Otherwise, use the triggering ref.
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref }}

      - name: Select Xcode (prefer Xcode 16+ if available)
        run: |
          set -euo pipefail
          ls -la /Applications | sed -n '1,200p'
          # Prefer any Xcode_16*.app if present; otherwise fall back to default Xcode.app
          CANDIDATE="$(ls -1d /Applications/Xcode_16*.app 2>/dev/null | head -n 1 || true)"
          if [ -n "$CANDIDATE" ]; then
            echo "Selecting $CANDIDATE"
            sudo xcode-select -s "$CANDIDATE/Contents/Developer"
          else
            echo "Selecting /Applications/Xcode.app"
            sudo xcode-select -s "/Applications/Xcode.app/Contents/Developer"
          fi
          xcodebuild -version
          swift --version

      - name: Prepare SPM checkouts (resolve + patch)
        run: |
          set -euo pipefail
          cd packages/mlx-host

          # Use an explicit source packages directory so we can apply small compatibility patches
          # (without relying on DerivedData paths).
          CLONED_SPM_DIR="$RUNNER_TEMP/spm-checkouts"
          mkdir -p "$CLONED_SPM_DIR"

          echo "Resolving package dependencies..."
          xcodebuild -resolvePackageDependencies \
            -scheme mlx-host \
            -destination 'platform=macOS' \
            -clonedSourcePackagesDirPath "$CLONED_SPM_DIR"

          # Work around Swift 5 language mode incompatibility in upstream mlx-swift-lm:
          # `Jamba.swift` uses a trailing comma in a function call argument list, which fails under `-swift-version 5`.
          JAMBA="$CLONED_SPM_DIR/checkouts/mlx-swift-lm/Libraries/MLXLLM/Models/Jamba.swift"
          if [ -f "$JAMBA" ]; then
            echo "Patching $JAMBA (remove trailing comma before closing ')')"
            # Xcode may create read-only working copies; make this checkout writable so we can patch it.
            chmod -R u+w "$CLONED_SPM_DIR/checkouts/mlx-swift-lm" || true
            # Replace:
            #   bias: self.useConvBias,
            # )
            # with:
            #   bias: self.useConvBias
            # )
            python3 - "$JAMBA" <<'PY'
          import pathlib
          import sys
          
          path = pathlib.Path(sys.argv[1])
          lines = path.read_text().splitlines(True)
          
          out: list[str] = []
          changed = False
          i = 0
          n = len(lines)
          
          
          def next_nonempty(idx: int) -> int:
              j = idx
              while j < n and lines[j].strip() == "":
                  j += 1
              return j
          
          
          while i < n:
              line = lines[i]
              if "bias: self.useConvBias," in line:
                  j = next_nonempty(i + 1)
                  if j < n and lines[j].lstrip().startswith(")"):
                      out.append(line.replace("bias: self.useConvBias,", "bias: self.useConvBias"))
                      changed = True
                      i += 1
                      continue
              out.append(line)
              i += 1
          
          if not changed:
              print("error: Jamba.swift patch made no changes (pattern not found)")
              raise SystemExit(1)
          
          path.write_text("".join(out))
          print("patched Jamba.swift")
          PY
          else
            echo "Expected file not found: $JAMBA" >&2
            echo "Contents of $CLONED_SPM_DIR/checkouts:" >&2
            ls -la "$CLONED_SPM_DIR/checkouts" >&2 || true
            exit 1
          fi

          # Persist for later steps.
          echo "CLONED_SPM_DIR=$CLONED_SPM_DIR" >> "$GITHUB_ENV"

      - name: Build mlx-host (arm64, Debug) via xcodebuild
        run: |
          set -euo pipefail
          cd packages/mlx-host

          # Capture full logs + xcresult so we can debug compiler failures.
          RESULT_BUNDLE="$RUNNER_TEMP/mlx-host.xcresult"
          LOG_FILE="$RUNNER_TEMP/xcodebuild-mlx-host.log"
          rm -rf "$RESULT_BUNDLE" || true
          : > "$LOG_FILE"
          set +e
          xcodebuild build \
            -scheme mlx-host \
            -destination 'platform=macOS' \
            -configuration Debug \
            ARCHS=arm64 \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGNING_ALLOWED=NO \
            -clonedSourcePackagesDirPath "$CLONED_SPM_DIR" \
            -resultBundlePath "$RESULT_BUNDLE" \
            | tee -a "$LOG_FILE"
          STATUS="${PIPESTATUS[0]}"
          set -e
          if [ "$STATUS" -ne 0 ]; then
            echo "xcodebuild failed with status $STATUS"
            exit "$STATUS"
          fi

          # Capture full logs + xcresult so we can debug compiler failures.
          RESULT_BUNDLE="$RUNNER_TEMP/mlx-host.xcresult"
          LOG_FILE="$RUNNER_TEMP/xcodebuild-mlx-host.log"
          set +e
          xcodebuild build \
            -scheme mlx-host \
            -destination 'platform=macOS' \
            -configuration Debug \
            ARCHS=arm64 \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGNING_ALLOWED=NO \
            -clonedSourcePackagesDirPath "$CLONED_SPM_DIR" \
            -resultBundlePath "$RESULT_BUNDLE" \
            | tee "$LOG_FILE"
          STATUS="${PIPESTATUS[0]}"
          set -e
          if [ "$STATUS" -ne 0 ]; then
            echo "xcodebuild failed with status $STATUS"
            exit "$STATUS"
          fi

      - name: Print first compiler error (if any)
        if: always()
        run: |
          set -euo pipefail
          LOG_FILE="$RUNNER_TEMP/xcodebuild-mlx-host.log"
          if [ -f "$LOG_FILE" ]; then
            echo "--- first 'error:' line (if present) ---"
            grep -n "error:" "$LOG_FILE" | head -n 1 || true
          else
            echo "No log file found at $LOG_FILE"
          fi

      - name: Upload build logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mlx-host-xcodebuild-debug
          if-no-files-found: ignore
          path: |
            ${{ runner.temp }}/xcodebuild-mlx-host.log
            ${{ runner.temp }}/mlx-host.xcresult

      - name: Locate build products
        id: locate
        run: |
          set -euo pipefail
          DD="$(ls -td "$HOME/Library/Developer/Xcode/DerivedData/mlx-host-"* | head -n 1)"
          echo "derived_data=$DD" >> "$GITHUB_OUTPUT"
          echo "DerivedData=$DD"

      - name: Collect release assets (mlx-host + mlx.metallib)
        run: |
          set -euo pipefail
          DD="${{ steps.locate.outputs.derived_data }}"
          OUT="dist-release/darwin-arm64"
          mkdir -p "$OUT"

          BIN="$DD/Build/Products/Debug/mlx-host"
          METAL="$DD/Build/Products/Debug/mlx-swift_Cmlx.bundle/Contents/Resources/default.metallib"

          if [ ! -f "$BIN" ]; then
            echo "mlx-host binary not found at $BIN" >&2
            exit 1
          fi
          if [ ! -f "$METAL" ]; then
            echo "default.metallib not found at $METAL" >&2
            exit 1
          fi

          cp "$BIN" "$OUT/mlx-host"
          chmod +x "$OUT/mlx-host"

          # MLX loader first tries to find a colocated `mlx.metallib`, so ship it with that name.
          cp "$METAL" "$OUT/mlx.metallib"

          echo "Assets in $OUT:"
          ls -la "$OUT"

          echo "Binary arch:"
          lipo -info "$OUT/mlx-host" || true

      - name: Create GitHub Release (if missing) + upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
          files: |
            dist-release/darwin-arm64/mlx-host
            dist-release/darwin-arm64/mlx.metallib
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

